<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>Test</title>
</head>
<script type="text/javascript">
<!--
var debugging = false;

var xmlhttp;

var commandQueue = '';

var changedTextFieldId = '';

function init()
{
  queueCommand('Init');
//  refresh();
}

function debug(message)
{
  if (debugging)
    document.getElementById('debugMessage').innerHTML=message;
}

function debugAdd(message)
{
  if (debugging)
    debug (message + '<br></br>' + document.getElementById('debugMessage').innerHTML);
}

function setRefreshTimer(ms)
{  
    setTimeout('refresh()',ms);
}

function refresh()
{
    queueCommand('Refresh');
    setRefreshTimer(1000);
}

/* For text fields, we just register that they have changed and send them with
   the queue after the first editing operation. Otherwise, when editing a text field and then
   clicking on eg. a radio button generates a server event for the text edit, which causes
   the radiobutton event to get lost. Better would be to remember the exact mouse position and
   generate the event again after the text edit has been handled. Now, if the text edit causes
   disabling and or restructuring of the interface, edit events will be sent which make no
   sense. By checking if the element that receives the event is still in the view structure
   after the text edit has been handled, and that it has not been disabled, we can cover for
   most problematic situations.
*/

function textFieldChanged(textFieldId)
{  changedTextFieldId = textFieldId;
}

// send any pending text changes
function textFieldGotFocus()
{ debugAdd ('text got focus changed='+changedTextFieldId);
   if (changedTextFieldId != "")
     queueCommand('');
}  

function addCommand(command)
{ commandQueue = commandQueue + (commandQueue != '' ? ',' : '') + command;
} // add command to queue, and if queue was not empty, put a comma in front

// TODO we don't want empty commands sent to server
function queueCommand(command)
{ 
  if (changedTextFieldId != "")
  { debugAdd(changedTextFieldId+" has changed");
    value = document.getElementById(changedTextFieldId).value;
    addCommand ('SetC '+changedTextFieldId+' "'+value+'"');
    changedTextFieldId = "";
 }
  if (command != '') addCommand(command);

  if ( xmlhttp && xmlhttp.readyState != 0 && xmlhttp.readyState != 4)
    return; // if xmlhttp exists and was initialized and not ready, we return
            // TODO: can readyState == 0 happen?  
             
xmlhttp=null;
if (window.XMLHttpRequest)
  { // code for Firefox, Opera, IE7, etc.
    xmlhttp=new XMLHttpRequest();
  }
else if (window.ActiveXObject)
  { // code for IE6, IE5
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
if (xmlhttp!=null)
  { 
    { xmlhttp.onreadystatechange=state_Change;
      xmlhttp.open("GET",'handle?commands=Commands ['+commandQueue+']',true);
      xmlhttp.send(null); // commands in commandQueue are already separated by commmas
      commandQueue = '';
    }
  }
else
  { alert("Your browser does not support XMLHTTP.");
  }
}

// tricky to do these as regular commands in the command queue.
function authenticate()
{ xmlhttp.onreadystatechange=state_Change;
  xmlhttp.open("GET",'authenticate',true);
  xmlhttp.send(null);
}

function unauthenticate()
{ xmlhttp.onreadystatechange=state_Change;
  xmlhttp.open("GET",'unauthenticate',true);
  xmlhttp.send(null);
}

function state_Change()
{
if (xmlhttp.readyState==4)
  {// 4 = "loaded"
  if (xmlhttp.status==200)
    {// 200 = "OK"

    debugAdd("received");
    var receivedUpdates = document.getElementById('receivedUpdates');
    receivedUpdates.innerHTML=xmlhttp.responseText;
    
    
    if (commandQueue != '')
    { debugAdd('sending queue');
      queueCommand('');
    }
    
   
    
    var updates = document.getElementById('updates');
    // getElementById seems to trigger parsing the responseText
    // after this, firstChild has a value, while it is null before
    // newRendering.firstChild;
    
    
   while (updates.firstChild)
    { updateTree( updates.firstChild );
    ; updates.removeChild(updates.firstChild);
    }
    

    
   }
  else
    {
    debug("Problem retrieving data:" + xmlhttp.statusText);
//    document.getElementById('status').innerHTML='Server not available.';
    }
  }
}

function updateTree(update)
{ var op = update.getAttribute('op');
 
 if (op === 'replace')
  { var targetId = update.getAttribute('targetId');
    var newChild = update.childNodes[0];
    debugAdd("replace");
    
    var oldChild = document.getElementById(targetId);
    
    var parent = oldChild.parentNode;
    
    parent.replaceChild(newChild,oldChild);
      
  } 
 else if (op === 'alert')
  { var text = update.getAttribute('text');
    alert(text);
  } 
 else if (op === 'confirm')
  { var text = update.getAttribute('text');
    if (confirm(text)) queueCommand('ConfirmDialogOk');;
  } 
 else if (op === 'authenticate')
  {  authenticate();
  } 
 else alert ('Unknown command: '+op); 
}

function select(path, node)
{ var step = path.firstChild;
  if (!step)
    return node;
  else
    { path.removeChild(step);
      var childNr = parseInt( step.getAttribute('childNr') ); 
      var child = node.childNodes[childNr];
      return (select (path, child));
    }
}

-->
</script>

<body onload="init()" style="padding:0px; margin:0px">
<button onClick="unauthenticate()">Logout</button>
<!-- <div style="border:solid; border-width:1px; margin:0px"> -->
<form onSubmit="queueCommand(''); return false"><div id="root">initial root</div></form>
<!-- </div> -->
<!-- Debug: -->
<div style="padding:4px;" id="debugMessage"></div>

<div id="receivedUpdates" style="visibility:hidden; border:solid; border-width:1px; padding:4px; border-color:red;" ></div>
</body> </html>
